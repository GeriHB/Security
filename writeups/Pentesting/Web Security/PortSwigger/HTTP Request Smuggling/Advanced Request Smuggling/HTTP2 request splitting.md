In the `Response queue poisoning` a single HTTP request was split into two complete requests on the backend. The split took place inside the message body.

But when the HTTP/2 downgrading is in play you can cause the split to occur in the headers.

This is more preferred because you are not dependent on methods that have body, for example you can use also a `GET` request.

this is also used where `content-length` is validated and backend don't support `chunked encoding`.

In order to do this, you have to understand how the request is rewritten by the frontend. For example, both requests received by the backend contain a `Host` header.

Frontend typically strip the `:authority` pseudo-header and replace it with a new `HTTP/1 Host` during downgrading. So, there are different approaches which can influence where you need to position the `Host` header that you will inject.

## HTTP/2 request splitting via CRLF injection

The goal is to delete the user `carlos` by using response queue poisoning to break into the admin panel `/admin`. An admin user will log in approx. every 10 seconds.

Send the request to the root, to `Repeater`.

Make sure that it is using `HTTP/2`, and then add a new header.

In the new header, just put some random name, and as the value, first give it a value, and then a new line, meaning `\r\n\r\n` this because the first `\r\n` is the end of the header and the second signals the end of the request.

Afterwards add the new request that will be the second complete request in the backend. We just request something that don't exist, in order to differentiate from the responses that might have something.

The header would look like:

```http
bar

GET /askcbsvfdv HTTP/1.1
Host: 0a2e008a04d2efd4806f5d4d008d00a1.web-security-academy.net
```

In Burp we can't send this to the Intruder se we have to work manually. Keep sending this request every few seconds, and you will get a `302 Found` status code. This means that the admin was logging in at that moment, and the queue poisoning made him have a `404 Not Found` and the `302` was sent to us.

There you will have also the admin's cookie, which will give us access to the admin page.

There we can see the link to delete the user `carlos` and by using that and the cookie we delete the account and solve the lab.

```http
HTTP/2 302 Found
Location: /admin
X-Frame-Options: SAMEORIGIN
Content-Length: 0

```
