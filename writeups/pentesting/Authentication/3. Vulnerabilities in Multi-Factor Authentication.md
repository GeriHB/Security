It's worth noting that the full multi-factor authentication are only achieved by verifying multiple different factors. For example, in email-based 2FA, although the user has to provide a password and a verification code, to access the code it relies on them knowing the login credentials for their email account, so it's only a `knowledge factor` which is being verified twice.

## Two-Factor Authentication Tokens

Using dedicated mobile apps, such as Google Authenticator is a common way that websites use for two-factor authentication.

But, there are also websites that send verification codes as a text message. And, this is open for abuse.

First, this code is sent by SMS rather than being generated by the device itself, and it creates the risk of the code to be intercepted. Or maybe even SIM swapping, where an attacker obtains a SIM card with the victim's phone number.

## Bypassing Two-Factor Authentication

When a user is `first` prompted to enter a password, and `second` prompted to enter a verification code on a separate page, the user is effectively in a `logged in` state.

In this case, it's worth testing to see if you can directly skip to "logged-in only" pages after completing the first authentication step. Sometimes, there are websites that don't actually check if you have or not completed the second page.

### Lab.1 2FA Simple Bypass

The lab supposes that I have obtained credentials `carlos:montoya` and my credentials are `wiener:peter`. So, to solve the lab I need to access Carlos's account page, but I don't have access to the user's 2FA verification code.

First, I login to my account `wiener:peter` and then I'm prompted to enter the 2FA code. 

This is on the URL: `/login2`

I can access this code by going to the email client.

After I provide the code, I'm redirected to a page with the URL:

`my-account?id=wiener`

Now, let's log out and try to login as carlos. And, I'm presented with the 2FA code page.

![[Pasted image 20250122103505.png]]

But, since I know the URL that it produces after giving the code, I will try to directly access it, as now I'm in a logged in state.

And, I have access to the page, so I bypassed the 2FA authentication.

![[Pasted image 20250122103644.png]]

-------

## Flawed Two-Factor Verification Logic

Sometimes 2FA means that a user has completed the initial login, but the website doesn't adequately check if the user has completed the second one.

A user logs in:

```http
POST /login-steps/first HTTP/1.1
Host: vulnerable-website.com
...
username=carlos&password=qwerty
```

They are assigned a cookie relating to the account, before taken to the second login process.

```http
HTTP/1.1 200 OK
Set-Cookie: account=carlos

GET /login-steps/second HTTP/1.1
Cookie: account=carlos
```

When submitting the verification code, this cookie is used by the request to determine which account the user is accessing.

```http
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=carlos
...
verification-code=123456
```

So, an attacker, can log in using their credentials, but change the value of the account to other username.

```http
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=victim-user
...
verification-code=123456
```

If the attacker then is able to brute-force the verification code, it can allow them to log in to arbitrary accounts based on their username, without knowing the password

### Lab. 2 - 2FA Broken Logic

You can log in with `wiener:peter` which is your account, but to solve the lab you need to log in to the `carlos` user account page.

First I log in to my account, and the request is as follows:

```http
GET /login2 HTTP/2
Host: 0ac8004b032adf42806e352400ab0088.web-security-academy.net
Cookie: verify=wiener; session=L06RUfV1kCz3yKDR0tCwfLSxFgAjRUCe
...
```

And when I provide the 2FA code, it is:

```http
POST /login2 HTTP/2
Host: 0ac8004b032adf42806e352400ab0088.web-security-academy.net
Cookie: verify=wiener; session=L06RUfV1kCz3yKDR0tCwfLSxFgAjRUCe
...

mfa-code=0191
```

So, now I send the first request to Burp Repeater, and change the value of `verify` to carlos:

```http
GET /login2 HTTP/2
Host: 0ac8004b032adf42806e352400ab0088.web-security-academy.net
Cookie: verify=carlos; session=L06RUfV1kCz3yKDR0tCwfLSxFgAjRUCe
...
```

This, in order to generate the 2FA code. Next, I send the second, `POST` request to the Intruder, and again change the `verify` to `carlos`.

I chose the Sniper Attack, and set the Payload Type to Numbers. In the number range, i start from `0000` to `9999`, and the Min. integer digits to `4`, and start the attack.

After a while I see a `302 code`, for the payload `0166`.

I go to the `Burp Repeater`, where I had the `POST` request for `carlos` and set the `mfa-code=0166` and send the request, and the response is `302 Found`, so I got access to it's page, without even knowing the password.

I request this page to open to the browser, and the lab is solved.

## Brute-Forcing 2FA verification codes

Usually the code is a simple 4 or 6-digit number. This means that brute-forcing is not really a hard thing to do, so websites should take additional measures to protect them.

Some websites try to prevent this by logging you out after a number of incorrect verification values. 

But, an attacker can leverage the `macros` for Burp Intruder or `Turbo Intruder` to bypass this.

### Lab.3 - 2FA Bypass Using a Brute-Force Attack

I have the victim's credentials `carlos:montoya` but not the user's 2FA verification code. To solve the lab I should log in to the user's page.

I logged in to the `carlos` account, but after I provided two times a wrong password, I got logged out.

Now, I need a way to automize the process of logging back in while brute-forcing.

For this, go to `Burp Settings` and in `Sessions`, in the `Scope` tab, select the `Include all URL's` in the `URL Scope`.

![[Pasted image 20250122111418.png]]

Then, go to the `Details` tab and in the `Rule Actions` add and run a macro.

Open the Macro Recorder and from the URL-s select the `GET /login`, `POST login`, and `GET /login2`.

![[Pasted image 20250122111850.png]]

Then `Test macro` and see the response to the `GET /login2` if you are prompted for the 2FA code.

![[Pasted image 20250122111958.png]]

Now, go back and add the `POST /login2` request to the `Intruder` and add a payload to the value of `mfa-code`.`

Select the `Brute Forcer` payload type, with the character set of only numbers [0-9] and min and max length of 4.

In the `Resource Pool` create a new one with the maximum concurrent requests of `1` and start the attack.

The process can take up some time, until we get a `302 Found`.

![[Pasted image 20250122143340.png]]

We click on show this response to the browser, and we are inside the `carlos` account page, and the lab is solved.

The process of brute forcing may be needed to be done more than one time, as the verification code will reset during the time. And the new code can be a number that the Intruder had already tested.